# Lab Testing Report - Iteration 1

**Date/Time**: $(date '+%Y-%m-%d %H:%M:%S')

## Summary

Iteration 1 of the lab testing cycle completed successfully. The deployment script was fixed to address controller installation issues, and all services are now operational.

## Deployment Status

| Component | Status | Notes |
|-----------|--------|-------|
| Ingress Controller | ✅ Running | nginx-ingress installed |
| Vault | ✅ Running | Initialized, unsealed, configured |
| Boundary Controller | ✅ Running | PostgreSQL backend operational |
| Boundary Worker | ✅ Running | Connected to controller |
| Keycloak | ✅ Running | PostgreSQL backend, realm configured |
| Claude Code Sandbox | ✅ Running | envbuilder completed |
| Gemini Sandbox | ✅ Running | envbuilder completed |
| VSO | ✅ Running | Secrets synced to devenv |

## Service Accessibility

| Service | URL | Status |
|---------|-----|--------|
| Keycloak | https://keycloak.hashicorp.lab | ✅ Accessible (Health: UP) |
| Boundary | https://boundary.hashicorp.lab | ✅ Accessible |

## OIDC Authentication Test

**Test**: test-oidc-browser.py  
**Result**: ✅ PASSED

The complete OIDC flow was validated:
1. Navigate to Boundary UI
2. Select DevOps scope
3. Select Keycloak auth method
4. Popup opened to Keycloak login
5. Credentials submitted (developer@example.com)
6. Callback processed successfully
7. User authenticated and redirected to scopes page

## Issues Found and Fixed

### Issue 1: Agent Sandbox Controller Not Installed

**Problem**: The deploy.sh script checked for CRD existence but didn't verify the controller was running. This caused sandbox pods to remain pending.

**Fix Applied**: Modified `/k8s/agent-sandbox/deploy.sh` to:
- Check both CRD existence AND controller pod status
- Only skip installation when both are satisfied
- Always apply manifests if controller isn't running

**Location**: Lines 65-87 of deploy.sh

### Issue 2: Deployment Failed on Parallel Task Timeout

**Problem**: Agent sandbox deployment timed out waiting for controller that wasn't installed.

**Root Cause**: Race condition where CRD was created in a previous partial deployment but controller never started.

**Resolution**: The fix ensures controller installation is idempotent and always verified.

## Timing Observations

Initial deployment was interrupted due to Issue 1. After fixing and running with RESUME=auto:
- Boundary PostgreSQL: ~90s for rollout
- Keycloak deployment: ~40s
- VSO Helm install: ~2m
- Boundary API readiness: ~30 attempts before ready

## Areas for Improvement Identified

1. **Replace remaining sleeps with deterministic waits**: Some timeout loops still use arbitrary sleep intervals
2. **Parallel deployment improvements**: Could optimize parallel task coordination
3. **Error reporting**: Better capture of failure reasons during parallel operations
4. **Controller installation**: Now fixed but should verify in iteration 2

## Recommendations for Iteration 2

1. Run full teardown to verify clean state
2. Measure complete deployment time from scratch
3. Test RESUME=auto functionality after fix
4. Verify the deploy.sh controller fix works in fresh deployment

---
*Report generated by lab-teardown-test automation*
