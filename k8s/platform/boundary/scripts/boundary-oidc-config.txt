==========================================
  Boundary OIDC Configuration (v0.20.1)
==========================================

Auth Method ID:     amoidc_Us9rH7Nwaa
Issuer:             https://keycloak.local/realms/agent-sandbox
API URL Prefix:     https://boundary.local
Callback URL:       https://boundary.local/v1/auth-methods/oidc:authenticate:callback
Client ID:          boundary
Client Secret:      xNyk1zav3KM9VUuwm5zBjtQgX1rnZO5h
State:              active-public
Validation:         disabled (using -disable-discovered-config-validation)

==========================================
  Managed Groups
==========================================

Admins Group:       mgoidc_CKeJM9PJU0 (keycloak-admins)
Developers Group:   mgoidc_uqK0kwRBHb (keycloak-developers)
Readonly Group:     mgoidc_MNSxOIMc6N (keycloak-readonly)

==========================================
  Group Mappings
==========================================

Keycloak Group      -> Boundary Access
-----------------------------------------
admins              -> Full access (all operations)
developers          -> Connect access (read + authorize-session on targets)
readonly            -> List access (read + list on all resources)

==========================================
  Keycloak Configuration Required
==========================================

1. Create client in Keycloak:
   - Realm: agent-sandbox
   - Client ID: boundary
   - Client Protocol: openid-connect
   - Access Type: confidential
   - Valid Redirect URIs:
     * https://boundary.local/v1/auth-methods/oidc:authenticate:callback
     * http://127.0.0.1:9200/v1/auth-methods/oidc:authenticate:callback

2. Configure client scopes to include 'groups' claim

3. Create groups in Keycloak:
   - admins
   - developers
   - readonly

4. Assign users to groups

==========================================
  Usage
==========================================

1. Access Boundary via browser:
   https://boundary.local

2. Or authenticate via CLI:
   export BOUNDARY_ADDR=https://boundary.local
   boundary authenticate oidc -auth-method-id=amoidc_Us9rH7Nwaa

3. Your browser will open for Keycloak login
   - Login with Keycloak credentials
   - You'll be redirected back to Boundary

4. Connect to targets based on your group membership

==========================================
  Upgrade Notes (0.17.2 -> 0.20.1)
==========================================

- Now using external issuer URL (https://keycloak.local)
- Discovery validation disabled to support external URLs
- Worker config uses initial_upstreams (not controllers)
- Database migrated to 0.20.1 schema

==========================================
  Critical: Keycloak frontendUrl Setting
==========================================

For OIDC to work with external users, the Keycloak realm's
frontendUrl attribute MUST be set to the external URL.

Without this, Keycloak returns internal URLs in the OIDC
discovery endpoint, causing issuer mismatch errors.

The realm init job (06-realm-init.yaml) now automatically
sets frontendUrl to $KEYCLOAK_EXTERNAL_URL after creating
the realm.

==========================================
  Boundary Controller hostAliases
==========================================

The Boundary controller pod requires hostAliases to resolve
keycloak.local to the ingress-nginx ClusterIP. This is needed
because CoreDNS forwards .local domains to the host resolver.

In 05-controller.yaml:
  hostAliases:
    - ip: "10.96.197.168"  # ingress-nginx-controller ClusterIP
      hostnames:
        - "keycloak.local"
        - "boundary.local"

If the cluster is recreated, update this IP to match the new
ingress-nginx-controller ClusterIP.

Updated: 2025-12-11
