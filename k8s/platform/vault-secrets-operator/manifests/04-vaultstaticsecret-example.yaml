# VaultStaticSecret - syncs devenv credentials from Vault to Kubernetes
# Includes GITHUB_TOKEN and other API credentials
apiVersion: secrets.hashicorp.com/v1beta1
kind: VaultStaticSecret
metadata:
  name: devenv-credentials
  namespace: devenv
spec:
  # Reference to VaultAuth in the same namespace
  vaultAuthRef: devenv-vault-auth

  # Type of secret engine (kv-v2 is default)
  type: kv-v2

  # Mount path of the KV secrets engine in Vault
  mount: secret

  # Path to the secret within the mount
  path: devenv/credentials

  # Destination Kubernetes secret
  destination:
    name: devenv-vault-secrets
    create: true
    # Transform secret keys to match expected env var names
    transformation:
      excludeRaw: true
      # Explicitly exclude lowercase keys to prevent duplicates
      excludes:
        - github_token
        - langfuse_host
        - langfuse_public_key
        - langfuse_secret_key
      templates:
        GITHUB_TOKEN:
          text: "{{ .Secrets.github_token }}"
        LANGFUSE_HOST:
          text: "{{ .Secrets.langfuse_host }}"
        LANGFUSE_PUBLIC_KEY:
          text: "{{ .Secrets.langfuse_public_key }}"
        LANGFUSE_SECRET_KEY:
          text: "{{ .Secrets.langfuse_secret_key }}"

  # How often to sync (default: 60s)
  refreshAfter: 30s

  # NOTE: rolloutRestartTargets only supports Deployment/DaemonSet/StatefulSet.
  # The Sandbox CRD creates bare pods, so VSO cannot auto-restart them.
  # For initial deployment, deploy-all.sh deletes the pod after VSO syncs.
  # For runtime secret updates, the pod must be manually restarted or
  # consider using a sidecar that watches the mounted secret file.
