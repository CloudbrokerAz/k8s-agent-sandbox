# ConfigMap containing devcontainer.json and entrypoint.sh
# Mounted into envbuilder to avoid requiring external git repo
apiVersion: v1
kind: ConfigMap
metadata:
  name: claude-code-devcontainer
data:
  devcontainer.json: |
    {
      "name": "Claude Code Sandbox",
      "image": "srlynch1/terraform-ai-tools:latest",
      "workspaceFolder": "/workspace",
      "mounts": [
        "source=claude-code-bashhistory,target=/commandhistory,type=volume",
        "source=claude-code-config,target=/home/node/.claude,type=volume"
      ],
      "features": {
        "ghcr.io/devcontainers/features/docker-in-docker:2": {},
        "ghcr.io/devcontainers/features/sshd:1": {
          "version": "latest"
        },
        "ghcr.io/coder/devcontainer-features/code-server:1": {
          "port": 13337,
          "host": "0.0.0.0"
        }
      },
      "postCreateCommand": "npm install -g @anthropic-ai/claude-code && claude --version && echo 'Claude Code Sandbox ready'",
      "appPort": ["13337:13337", "22:22"],
      "remoteUser": "node",
      "containerUser": "node",
      "remoteEnv": {
        "NODE_OPTIONS": "--max-old-space-size=4096",
        "CLAUDE_CONFIG_DIR": "/home/node/.claude",
        "POWERLEVEL9K_DISABLE_GITSTATUS": "true",
        "CLAUDE_GITHUB_MCP_ENABLED": "true"
      },
      "customizations": {
        "vscode": {
          "extensions": [
            "dbaeumer.vscode-eslint",
            "esbenp.prettier-vscode",
            "hashicorp.terraform",
            "Anthropic.claude-code",
            "redhat.vscode-yaml",
            "HashiCorp.HCL",
            "ms-kubernetes-tools.vscode-kubernetes-tools"
          ],
          "settings": {
            "editor.formatOnSave": true,
            "terminal.integrated.defaultProfile.linux": "bash"
          }
        }
      }
    }

  entrypoint.sh: |
    #!/bin/bash
    # entrypoint.sh - Claude Code Sandbox initialization
    # Called by envbuilder after devcontainer build completes
    set -e

    echo "========================================="
    echo "  Claude Code Sandbox Initializing..."
    echo "========================================="

    # -----------------------------------------------------------------------------
    # Background SSH Configuration
    # Waits for sudo to be ready, then configures SSH CA and starts sshd
    # -----------------------------------------------------------------------------
    (
      # Wait for sudo to be configured (check every 5 seconds, max 2 minutes)
      for i in {1..24}; do
        if sudo -n true 2>/dev/null; then
          break
        fi
        sleep 5
      done

      # If sudo is available, configure SSH
      if sudo -n true 2>/dev/null; then
        # Configure Vault SSH CA (if mounted)
        if [ -f /vault-ssh-ca/vault-ssh-ca.pub ]; then
          sudo cp /vault-ssh-ca/vault-ssh-ca.pub /etc/ssh/vault-ssh-ca.pub 2>/dev/null || true
          sudo chmod 644 /etc/ssh/vault-ssh-ca.pub 2>/dev/null || true

          # Add to sshd_config if not present
          if ! sudo grep -q "TrustedUserCAKeys /etc/ssh/vault-ssh-ca.pub" /etc/ssh/sshd_config 2>/dev/null; then
            echo "" | sudo tee -a /etc/ssh/sshd_config > /dev/null 2>&1
            echo "# Vault SSH CA Authentication" | sudo tee -a /etc/ssh/sshd_config > /dev/null 2>&1
            echo "TrustedUserCAKeys /etc/ssh/vault-ssh-ca.pub" | sudo tee -a /etc/ssh/sshd_config > /dev/null 2>&1
            echo "AuthorizedPrincipalsFile none" | sudo tee -a /etc/ssh/sshd_config > /dev/null 2>&1
          fi
        fi

        # Start SSH server (if not already running)
        if ! pgrep -x sshd > /dev/null 2>&1; then
          sudo mkdir -p /run/sshd 2>/dev/null || true
          sudo /usr/sbin/sshd 2>/dev/null || true
        fi
      fi
    ) &

    # -----------------------------------------------------------------------------
    # 1. Configure Vault TLS CA Trust (requires root/sudo)
    # -----------------------------------------------------------------------------
    if [ -f /vault-ca/vault-ca.crt ]; then
        echo "[1/5] Configuring Vault TLS CA trust..."
        if sudo cp /vault-ca/vault-ca.crt /usr/local/share/ca-certificates/vault-ca.crt 2>/dev/null; then
            sudo update-ca-certificates 2>/dev/null || true
            echo "  ✓ Vault TLS CA trusted system-wide"
        else
            echo "  - Vault TLS CA: sudo not available, using NODE_EXTRA_CA_CERTS"
            # Set NODE_EXTRA_CA_CERTS for Node.js applications
            export NODE_EXTRA_CA_CERTS=/vault-ca/vault-ca.crt
            echo "  ✓ Set NODE_EXTRA_CA_CERTS for Node.js trust"
        fi
    else
        echo "[1/5] Vault TLS CA not mounted at /vault-ca/vault-ca.crt, skipping..."
    fi

    # -----------------------------------------------------------------------------
    # 2. Configure Vault SSH CA for Certificate Authentication (requires root)
    # -----------------------------------------------------------------------------
    if [ -f /vault-ssh-ca/vault-ssh-ca.pub ]; then
        echo "[2/5] Configuring Vault SSH CA..."
        if sudo cp /vault-ssh-ca/vault-ssh-ca.pub /etc/ssh/vault-ssh-ca.pub 2>/dev/null; then
            sudo chmod 644 /etc/ssh/vault-ssh-ca.pub
            # Add TrustedUserCAKeys to sshd_config if not present
            if ! sudo grep -q "TrustedUserCAKeys /etc/ssh/vault-ssh-ca.pub" /etc/ssh/sshd_config 2>/dev/null; then
                echo "" | sudo tee -a /etc/ssh/sshd_config > /dev/null
                echo "# Vault SSH CA Authentication" | sudo tee -a /etc/ssh/sshd_config > /dev/null
                echo "TrustedUserCAKeys /etc/ssh/vault-ssh-ca.pub" | sudo tee -a /etc/ssh/sshd_config > /dev/null
                echo "AuthorizedPrincipalsFile none" | sudo tee -a /etc/ssh/sshd_config > /dev/null
            fi
            echo "  ✓ Vault SSH CA configured"
        else
            echo "  - Vault SSH CA: sudo not available, SSH cert auth disabled"
        fi
    else
        echo "[2/5] Vault SSH CA not mounted at /vault-ssh-ca/vault-ssh-ca.pub, skipping..."
    fi

    # -----------------------------------------------------------------------------
    # 3. Ensure SSH Server is Running (SSH feature starts its own server)
    # -----------------------------------------------------------------------------
    echo "[3/5] Checking SSH server..."
    if command -v sshd &> /dev/null; then
        if pgrep -x sshd > /dev/null; then
            echo "  ✓ SSH server already running (PID: $(pgrep -x sshd | head -1))"
        else
            # Start sshd with sudo
            sudo mkdir -p /run/sshd 2>/dev/null || true
            if sudo /usr/sbin/sshd 2>/dev/null; then
                echo "  ✓ SSH server started"
            else
                echo "  - SSH server failed to start, use 'sshd' feature port 2222"
            fi
        fi
    else
        echo "  - SSHD not installed"
    fi

    # -----------------------------------------------------------------------------
    # 4. Verify Claude Code (pre-installed in base image)
    # Base image srlynch1/terraform-ai-tools already has claude-code installed
    # at /usr/local/share/npm-global/bin/claude
    # -----------------------------------------------------------------------------
    echo "[4/5] Verifying Claude Code..."

    # npm-global path from base image
    NPM_GLOBAL_BIN="/usr/local/share/npm-global/bin"
    export PATH="$NPM_GLOBAL_BIN:$PATH"

    if [ -x "$NPM_GLOBAL_BIN/claude" ]; then
        CLAUDE_VERSION=$("$NPM_GLOBAL_BIN/claude" --version 2>/dev/null || echo "installed")
        echo "  ✓ Claude Code: ${CLAUDE_VERSION}"
    elif command -v claude &> /dev/null; then
        CLAUDE_VERSION=$(claude --version 2>/dev/null || echo "installed")
        echo "  ✓ Claude Code: ${CLAUDE_VERSION}"
    else
        echo "  - Claude Code not found, installing..."
        NPM_CONFIG_PREFIX=/usr/local/share/npm-global npm install -g @anthropic-ai/claude-code 2>&1 | tail -3
        if [ -x "$NPM_GLOBAL_BIN/claude" ]; then
            echo "  ✓ Claude Code installed"
        else
            echo "  ✗ Claude Code installation failed"
        fi
    fi

    # -----------------------------------------------------------------------------
    # 5. Start code-server
    # -----------------------------------------------------------------------------
    echo "[5/5] Starting code-server..."
    if command -v code-server &> /dev/null; then
        # Kill any existing instance
        pkill -f "code-server" 2>/dev/null || true
        sleep 1

        # Start code-server in background
        code-server --bind-addr 0.0.0.0:13337 --auth none /workspaces &
        CODE_SERVER_PID=$!
        sleep 2

        if kill -0 $CODE_SERVER_PID 2>/dev/null; then
            echo "  ✓ code-server started on port 13337"
        else
            echo "  ✗ code-server failed to start"
        fi
    else
        echo "  - code-server not installed"
    fi

    # -----------------------------------------------------------------------------
    # Print Access Information
    # -----------------------------------------------------------------------------
    echo ""
    echo "========================================="
    echo "  Claude Code Sandbox Ready!"
    echo "========================================="
    echo ""
    echo "Access Methods:"
    echo "  - code-server: http://localhost:13337 (via port-forward)"
    echo "  - SSH: port 22 (via Boundary or port-forward)"
    echo "  - kubectl exec: direct shell access"
    echo ""
    echo "========================================="

    # -----------------------------------------------------------------------------
    # Keep Container Running
    # -----------------------------------------------------------------------------
    # Wait for code-server or sshd, fallback to tail
    if [[ -n "${CODE_SERVER_PID:-}" ]] && kill -0 $CODE_SERVER_PID 2>/dev/null; then
        wait $CODE_SERVER_PID
    elif pgrep -x sshd > /dev/null; then
        wait $(pgrep -x sshd | head -1) 2>/dev/null || exec tail -f /dev/null
    else
        exec tail -f /dev/null
    fi
