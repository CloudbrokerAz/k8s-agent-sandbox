# VSCode Sandbox - Following kubernetes-sigs/agent-sandbox pattern exactly
# Reference: https://github.com/kubernetes-sigs/agent-sandbox/tree/f735f9833ecfed56faeef6101be8fb08ee73a7d2/examples/vscode-sandbox
apiVersion: agents.x-k8s.io/v1alpha1
kind: Sandbox
metadata:
  name: gemini-sandbox
spec:
  podTemplate:
    metadata:
      labels:
        sandbox: gemini-sandbox
        app: gemini-sandbox
    spec:
      containers:
        - name: devcontainer-main
          image: ghcr.io/coder/envbuilder
          resources:
            requests:
              cpu: "1000m"
              memory: "2Gi"
              ephemeral-storage: "10Gi"
            limits:
              ephemeral-storage: "10Gi"
          env:
            - name: ENVBUILDER_GIT_URL
              value: "https://github.com/CloudbrokerAz/k8s-agent-sandbox.git"
            - name: ENVBUILDER_DEVCONTAINER_DIR
              value: "k8s/agent-sandbox/vscode-gemini"
            - name: ENVBUILDER_GIT_CLONE_SINGLE_BRANCH
              value: "true"
            - name: ENVBUILDER_INIT_SCRIPT
              value: "k8s/agent-sandbox/vscode-gemini/entrypoint.sh"
            - name: AGENT_PROMPT
              value: "You are an expert kubernetes developer who is helping with code reviews. Please look at the most recent commit and provide a review feedback. Dont make any code changes. Would you approve it ?"
            - name: ENVBUILDER_IGNORE_PATHS
              value: "/var/run,/product_uuid,/product_name,/tokens,/var/run/secrets,/vault-ssh-ca,/vault-ca"

            # Vault integration
            - name: VAULT_ADDR
              value: "https://vault.vault.svc.cluster.local:8200"
            - name: VAULT_CACERT
              value: "/vault-ca/vault-ca.crt"

            # GitHub token for private repo access
            - name: GITHUB_TOKEN
              valueFrom:
                secretKeyRef:
                  name: devenv-vault-secrets
                  key: GITHUB_TOKEN
                  optional: true

            # Terraform Cloud token
            - name: TFE_TOKEN
              valueFrom:
                secretKeyRef:
                  name: devenv-vault-secrets
                  key: TFE_TOKEN
                  optional: true
            - name: TF_TOKEN_app_terraform_io
              valueFrom:
                secretKeyRef:
                  name: devenv-vault-secrets
                  key: TFE_TOKEN
                  optional: true

            # Langfuse observability
            - name: LANGFUSE_HOST
              valueFrom:
                secretKeyRef:
                  name: devenv-vault-secrets
                  key: LANGFUSE_HOST
                  optional: true
            - name: LANGFUSE_PUBLIC_KEY
              valueFrom:
                secretKeyRef:
                  name: devenv-vault-secrets
                  key: LANGFUSE_PUBLIC_KEY
                  optional: true
            - name: LANGFUSE_SECRET_KEY
              valueFrom:
                secretKeyRef:
                  name: devenv-vault-secrets
                  key: LANGFUSE_SECRET_KEY
                  optional: true

          volumeMounts:
            - mountPath: /workspaces
              name: workspaces-pvc
            # Vault CA certificates (read-only)
            - mountPath: /vault-ssh-ca
              name: vault-ssh-ca
              readOnly: true
            - mountPath: /vault-ca
              name: vault-ca
              readOnly: true

      volumes:
        - name: vault-ssh-ca
          secret:
            secretName: vault-ssh-ca
            optional: true
        - name: vault-ca
          secret:
            secretName: vault-tls-ca
            optional: true

  volumeClaimTemplates:
    - metadata:
        name: workspaces-pvc
      spec:
        accessModes:
          - ReadWriteOnce
        resources:
          requests:
            storage: 10Gi
