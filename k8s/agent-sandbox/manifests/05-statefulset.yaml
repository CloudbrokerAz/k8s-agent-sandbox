apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: devenv
  namespace: devenv
  labels:
    app: devenv
spec:
  serviceName: devenv
  replicas: 1
  selector:
    matchLabels:
      app: devenv
  template:
    metadata:
      labels:
        app: devenv
    spec:
      # Relaxed security context for development environment
      securityContext:
        runAsUser: 0
        runAsGroup: 0
        fsGroup: 0

      containers:
        - name: devenv
          image: agent-sandbox:latest
          imagePullPolicy: IfNotPresent

          # Startup script to install tools
          command: ["/bin/bash", "-c"]
          args:
            - |
              echo "========================================="
              echo "Agent Sandbox starting..."
              echo "========================================="

              # Create workspace directories
              echo "[1/4] Creating directories..."
              mkdir -p /workspace /commandhistory
              echo "  ✓ Directories created"

              # Install Claude Code
              echo "[2/4] Installing Claude Code..."
              if command -v claude &> /dev/null; then
                echo "  ✓ Claude Code already installed: $(claude --version 2>/dev/null || echo 'installed')"
              else
                echo "  - Installing via npm..."
                npm install -g @anthropic-ai/claude-code 2>&1 | tail -10
                if command -v claude &> /dev/null; then
                  echo "  ✓ Claude Code installed successfully"
                else
                  echo "  ✗ Claude Code install failed (will retry on next startup)"
                fi
              fi

              # Install Bun
              echo "[3/4] Installing Bun..."
              if command -v bun &> /dev/null; then
                echo "  ✓ Bun already installed: $(bun --version 2>/dev/null)"
              else
                echo "  - Installing Bun..."
                curl -fsSL https://bun.sh/install | bash 2>&1 | tail -5
                export BUN_INSTALL="$HOME/.bun"
                export PATH="$BUN_INSTALL/bin:$PATH"
                if command -v bun &> /dev/null; then
                  echo "  ✓ Bun installed successfully"
                else
                  echo "  ✗ Bun install failed"
                fi
              fi

              # Install ccstatusline
              echo "[4/4] Installing ccstatusline..."
              if command -v bun &> /dev/null; then
                bunx ccstatusline@latest 2>&1 | tail -3 || echo "  - ccstatusline setup skipped"
              else
                npx ccstatusline@latest 2>&1 | tail -3 || echo "  - ccstatusline setup skipped"
              fi

              echo "========================================="
              echo "Agent Sandbox ready!"
              echo "Access: kubectl exec -it devenv-0 -n devenv -- /bin/bash"
              echo "========================================="

              # Keep container running
              exec tail -f /dev/null
          # Environment variables from secrets
          env:
            - name: GITHUB_TOKEN
              valueFrom:
                secretKeyRef:
                  name: devenv-vault-secrets
                  key: GITHUB_TOKEN
                  optional: true
            - name: TFE_TOKEN
              valueFrom:
                secretKeyRef:
                  name: devenv-vault-secrets
                  key: TFE_TOKEN
                  optional: true
            - name: TF_TOKEN_app_terraform_io
              valueFrom:
                secretKeyRef:
                  name: devenv-vault-secrets
                  key: TFE_TOKEN
                  optional: true
            - name: LANGFUSE_HOST
              valueFrom:
                secretKeyRef:
                  name: devenv-vault-secrets
                  key: LANGFUSE_HOST
                  optional: true
            - name: LANGFUSE_PUBLIC_KEY
              valueFrom:
                secretKeyRef:
                  name: devenv-vault-secrets
                  key: LANGFUSE_PUBLIC_KEY
                  optional: true
            - name: LANGFUSE_SECRET_KEY
              valueFrom:
                secretKeyRef:
                  name: devenv-vault-secrets
                  key: LANGFUSE_SECRET_KEY
                  optional: true
            - name: VAULT_ADDR
              value: "https://vault.vault.svc.cluster.local:8200"
            - name: VAULT_CACERT
              value: "/vault-ca/vault-ca.crt"
            - name: CLAUDE_CONFIG_DIR
              value: "/home/node/.claude"
            - name: NODE_OPTIONS
              value: "--max-old-space-size=4096"

          # Resource limits
          resources:
            requests:
              memory: "2Gi"
              cpu: "500m"
            limits:
              memory: "4Gi"
              cpu: "2000m"

          # Volume mounts
          volumeMounts:
            - name: workspace
              mountPath: /workspace
            - name: bash-history
              mountPath: /commandhistory
            - name: claude-config
              mountPath: /home/node/.claude
            - name: vault-ca
              mountPath: /vault-ca
              readOnly: true

          # Relaxed security context for development
          securityContext:
            privileged: false
            allowPrivilegeEscalation: true

          # Simple health checks
          livenessProbe:
            exec:
              command: ["/bin/bash", "-c", "echo healthy"]
            initialDelaySeconds: 30
            periodSeconds: 30

          readinessProbe:
            exec:
              command: ["/bin/bash", "-c", "echo ready"]
            initialDelaySeconds: 10
            periodSeconds: 10

      volumes:
        - name: vault-ca
          secret:
            secretName: vault-tls-ca
            optional: true

      # Termination grace period
      terminationGracePeriodSeconds: 30

  # Volume claim templates for StatefulSet
  volumeClaimTemplates:
    - metadata:
        name: workspace
        labels:
          app: devenv
      spec:
        accessModes: ["ReadWriteOnce"]
        storageClassName: standard # Change based on your cluster
        resources:
          requests:
            storage: 10Gi

    - metadata:
        name: bash-history
        labels:
          app: devenv
      spec:
        accessModes: ["ReadWriteOnce"]
        storageClassName: standard
        resources:
          requests:
            storage: 1Gi

    - metadata:
        name: claude-config
        labels:
          app: devenv
      spec:
        accessModes: ["ReadWriteOnce"]
        storageClassName: standard
        resources:
          requests:
            storage: 1Gi
