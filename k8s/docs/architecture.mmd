%%{init: {'theme': 'base', 'themeVariables': { 'primaryColor': '#326CE5', 'primaryTextColor': '#fff', 'primaryBorderColor': '#326CE5', 'lineColor': '#326CE5', 'secondaryColor': '#006BFF', 'tertiaryColor': '#fff'}}}%%
flowchart TB
    subgraph External["External Access"]
        User["User<br/>(Developer)"]
        VSCode["VS Code<br/>Remote SSH"]
        BoundaryCLI["Boundary CLI"]
        VaultCLI["Vault CLI"]
        Browser["Web Browser"]
    end

    subgraph ingress["ingress-nginx namespace"]
        IngressController["NGINX Ingress Controller"]
        subgraph IngressRoutes["Ingress Routes (TLS)"]
            VaultIngress["vault.local:443"]
            BoundaryIngress["boundary.local:443"]
            BoundaryWorkerIngress["boundary-worker.local:443"]
            KeycloakIngress["keycloak.local:443"]
        end
    end

    subgraph K8s["Kubernetes Cluster"]
        subgraph devenv["devenv namespace"]
            subgraph SandboxCRD["Claude Code Sandbox (Sandbox CRD)"]
                EnvBuilder["envbuilder<br/>Container"]
                DevContainer["DevContainer<br/>(code-server + Claude Code)"]
            end
            SandboxSVC["claude-code-sandbox Service<br/>:22 SSH, :13337 code-server"]
            DevEnvSecrets["devenv-vault-secrets<br/>(VSO Synced)"]
            TFEToken["tfe-dynamic-token<br/>(Vault Dynamic)"]
            SSHCA["vault-ssh-ca<br/>(CA Public Key)"]
            VaultTLSCA["vault-tls-ca<br/>(TLS Certificate)"]
            subgraph SandboxPVCs["Persistent Storage"]
                WorkspacePVC["workspaces-pvc<br/>(20Gi)"]
                ConfigPVC["claude-config-pvc<br/>(1Gi)"]
                HistoryPVC["bash-history-pvc<br/>(1Gi)"]
            end
            DevContainerCM["devcontainer ConfigMap<br/>(devcontainer.json + entrypoint.sh)"]
        end

        subgraph vault["vault namespace"]
            VaultPod["Vault<br/>StatefulSet"]
            VaultSVC["vault Service<br/>:8200 API"]
            subgraph VaultEngines["Secrets Engines"]
                KV["KV v2<br/>secret/"]
                SSH["SSH CA<br/>ssh/"]
                TFE["Terraform<br/>terraform/"]
            end
        end

        subgraph boundary["boundary namespace"]
            Postgres["PostgreSQL<br/>StatefulSet"]
            Controller["Boundary Controller<br/>:9200 API<br/>:9201 Cluster"]
            Worker["Boundary Worker<br/>:9202 Proxy"]
            subgraph BoundaryConfig["Configuration"]
                Scopes["Scopes<br/>(DevOps/Agent-Sandbox)"]
                Targets["SSH Target<br/>(devenv-ssh)"]
                CredStore["Vault Credential Store"]
                CredLib["SSH Cert Library"]
            end
        end

        subgraph keycloak["keycloak namespace"]
            KeycloakDB["PostgreSQL<br/>StatefulSet"]
            KeycloakPod["Keycloak<br/>Deployment"]
            KeycloakSVC["keycloak Service<br/>:8080 HTTP"]
            subgraph KeycloakConfig["OIDC Configuration"]
                Realm["agent-sandbox Realm"]
                Client["boundary OIDC Client"]
                Users["Demo Users<br/>(admin@example.com,<br/>developer@example.com,<br/>readonly@example.com)"]
                Groups["Groups<br/>(admins, developers, readonly)"]
            end
        end

        subgraph vso["vault-secrets-operator-system namespace"]
            VSOController["VSO Controller<br/>Manager"]
        end

        subgraph agentsandbox["agent-sandbox-system namespace"]
            SandboxController["Sandbox Controller<br/>Manager"]
        end
    end

    %% User Access Flows
    User --> BoundaryCLI
    User --> VaultCLI
    User --> VSCode
    User --> Browser

    %% Ingress Flows
    Browser -->|"HTTPS"| IngressController
    VaultCLI -->|"HTTPS"| IngressController
    IngressController --> VaultIngress
    IngressController --> BoundaryIngress
    IngressController --> BoundaryWorkerIngress
    IngressController --> KeycloakIngress
    VaultIngress -->|"HTTP"| VaultSVC
    BoundaryIngress -->|"HTTP"| Controller
    BoundaryWorkerIngress -->|"HTTP"| Worker
    KeycloakIngress -->|"HTTP"| KeycloakSVC

    %% Boundary CLI connects via Ingress
    BoundaryCLI -->|"HTTPS"| IngressController

    %% Boundary Authentication Flow (internal after ingress)
    Controller -->|"OIDC Redirect"| KeycloakSVC
    KeycloakSVC -->|"Validate & Return Token"| Controller

    %% Boundary SSH Access Flow (internal)
    Controller -->|"Authorize Session"| Worker
    Worker -->|"SSH Proxy"| SandboxSVC
    SandboxSVC --> DevContainer

    %% VS Code SSH via Boundary (through local proxy then ingress)
    VSCode -->|"SSH to localhost:2222"| BoundaryCLI

    %% Credential Brokering Flow
    CredStore -->|"Token"| VaultSVC
    CredLib -->|"ssh/sign/devenv-access"| SSH
    Targets --> CredLib
    Worker -->|"Fetch SSH Cert"| CredStore

    %% OIDC Authentication Flow
    Controller -->|"OIDC Auth"| KeycloakSVC
    KeycloakSVC --> KeycloakPod
    KeycloakPod --> KeycloakDB
    KeycloakPod --> Realm
    Realm --> Client
    Realm --> Users
    Realm --> Groups

    %% Vault Secrets Operator Flow
    VSOController -->|"Watch VaultStaticSecret"| devenv
    VSOController -->|"Fetch Secrets"| VaultSVC
    VSOController -->|"Create/Update"| DevEnvSecrets

    %% Vault Internal
    VaultPod --> KV
    VaultPod --> SSH
    VaultPod --> TFE
    VaultSVC --> VaultPod

    %% Sandbox Secret Consumption
    DevContainer -->|"GITHUB_TOKEN"| DevEnvSecrets
    DevContainer -->|"TFE_TOKEN"| TFEToken
    DevContainer -->|"SSH CA Trust"| SSHCA
    DevContainer -->|"TLS Trust"| VaultTLSCA

    %% Sandbox Internal Flow
    EnvBuilder -->|"Builds"| DevContainer
    DevContainer -->|"Mounts"| DevContainerCM
    DevContainer -->|"Uses"| WorkspacePVC
    DevContainer -->|"Uses"| ConfigPVC
    DevContainer -->|"Uses"| HistoryPVC

    %% Sandbox Controller Flow
    SandboxController -->|"Watch Sandbox CRD"| devenv
    SandboxController -->|"Create/Manage Pod"| SandboxCRD

    %% Boundary Internal
    Controller --> Postgres
    Controller --> Scopes
    Scopes --> Targets
    Targets --> CredStore
    CredStore --> CredLib

    %% Styles
    classDef user fill:#4CAF50,stroke:#388E3C,color:#fff
    classDef external fill:#2196F3,stroke:#1565C0,color:#fff
    classDef vault fill:#FFD700,stroke:#FFA000,color:#000
    classDef boundary fill:#F06292,stroke:#C2185B,color:#fff
    classDef keycloak fill:#00BCD4,stroke:#00838F,color:#fff
    classDef sandbox fill:#9C27B0,stroke:#6A1B9A,color:#fff
    classDef vso fill:#FF9800,stroke:#E65100,color:#fff
    classDef secret fill:#E8F5E9,stroke:#4CAF50,color:#000
    classDef storage fill:#607D8B,stroke:#455A64,color:#fff
    classDef config fill:#8BC34A,stroke:#558B2F,color:#fff
    classDef ingress fill:#4DB6AC,stroke:#00897B,color:#fff

    class User,VSCode,BoundaryCLI,VaultCLI,Browser external
    class VaultPod,VaultSVC,KV,SSH,TFE vault
    class Controller,Worker,Postgres,Scopes,Targets,CredStore,CredLib boundary
    class KeycloakPod,KeycloakDB,KeycloakSVC,Realm,Client,Users,Groups keycloak
    class EnvBuilder,DevContainer,SandboxSVC sandbox
    class VSOController,SandboxController vso
    class DevEnvSecrets,TFEToken,SSHCA,VaultTLSCA secret
    class WorkspacePVC,ConfigPVC,HistoryPVC storage
    class DevContainerCM config
    class IngressController,VaultIngress,BoundaryIngress,BoundaryWorkerIngress,KeycloakIngress ingress
