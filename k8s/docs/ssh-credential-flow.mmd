%%{init: {'theme': 'base', 'themeVariables': { 'primaryColor': '#326CE5'}}}%%
sequenceDiagram
    autonumber
    participant User as Developer
    participant VSCode as VS Code<br/>Remote SSH
    participant BC as Boundary CLI/<br/>Desktop
    participant Ctrl as Boundary Controller
    participant KC as Keycloak<br/>(agent-sandbox realm)
    participant Worker as Boundary Worker
    participant Vault as HashiCorp Vault
    participant DevEnv as Claude Code Sandbox<br/>(Sandbox CRD Pod)

    Note over User,DevEnv: Complete SSH Connection Flow via Boundary + Keycloak OIDC

    %% Authentication Phase
    rect rgb(240, 248, 255)
        Note right of User: 1. Authentication Phase
        User->>BC: boundary authenticate oidc
        BC->>Ctrl: Initiate OIDC flow
        Ctrl->>KC: Redirect to Keycloak login
        KC-->>User: Login page (agent-sandbox realm)
        User->>KC: Enter credentials<br/>(admin@example.com / Admin123!@#)
        KC->>KC: Validate user & fetch groups<br/>(admins, developers, readonly)
        KC-->>Ctrl: ID Token + groups claim
        Ctrl->>Ctrl: Map groups to managed groups
        Ctrl-->>BC: Session token
        BC-->>User: Authenticated successfully
    end

    %% Connection Phase
    rect rgb(255, 248, 240)
        Note right of User: 2. SSH Connection Phase
        User->>BC: boundary connect ssh -target-id=devenv<br/>-listen-port=2222
        BC->>Ctrl: Request connection to target
        Ctrl->>Ctrl: Authorize (check roles/grants)
        Ctrl->>Worker: Create session
        Worker->>Vault: Request SSH certificate<br/>(ssh/sign/devenv-access)
        Vault-->>Worker: Signed SSH certificate
        BC-->>User: Local proxy listening on :2222
    end

    %% VS Code Connection Phase
    rect rgb(240, 255, 240)
        Note right of User: 3. VS Code Remote SSH Phase
        User->>VSCode: Open Remote SSH to localhost:2222
        VSCode->>BC: SSH connection to :2222
        BC->>Worker: Forward via Boundary tunnel
        Worker->>DevEnv: SSH connection with Vault cert
        DevEnv->>DevEnv: Validate cert against<br/>Vault SSH CA (TrustedUserCAKeys)
        DevEnv-->>Worker: SSH session established
        Worker-->>BC: Tunnel active
        BC-->>VSCode: SSH session ready
        VSCode->>DevEnv: Install vscode-server
        DevEnv-->>VSCode: Full IDE session active
    end

    Note over User,DevEnv: Developer has full VS Code IDE access to Sandbox pod<br/>with Claude Code, Terraform, AWS CLI, and all tools
