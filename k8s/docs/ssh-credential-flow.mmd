%%{init: {'theme': 'base', 'themeVariables': { 'primaryColor': '#326CE5'}}}%%
sequenceDiagram
    autonumber
    participant User as Developer
    participant BC as Boundary CLI
    participant Ctrl as Boundary Controller
    participant KC as Keycloak
    participant Worker as Boundary Worker
    participant Vault as HashiCorp Vault
    participant DevEnv as Agent Sandbox<br/>(devenv-0)

    Note over User,DevEnv: SSH Connection with Vault-Signed Certificates

    %% Authentication Phase
    rect rgb(240, 248, 255)
        Note right of User: Authentication Phase
        User->>BC: boundary authenticate oidc
        BC->>Ctrl: Initiate OIDC flow
        Ctrl->>KC: Redirect to Keycloak
        KC-->>User: Login page
        User->>KC: Enter credentials
        KC-->>Ctrl: OIDC tokens + claims
        Ctrl-->>BC: Session token
        BC-->>User: Authenticated
    end

    %% Connection Phase
    rect rgb(255, 248, 240)
        Note right of User: SSH Connection Phase
        User->>BC: boundary connect ssh -target-id=...
        BC->>Ctrl: Request connection to target
        Ctrl->>Ctrl: Authorize (check roles/grants)
        Ctrl->>Worker: Create session
        Worker->>Vault: Request SSH certificate<br/>(ssh/sign/devenv-access)
        Vault-->>Worker: Signed SSH certificate
        Worker->>DevEnv: SSH connection with cert
        DevEnv->>DevEnv: Validate cert against<br/>Vault SSH CA
        DevEnv-->>Worker: SSH session established
        Worker-->>BC: Proxy connection ready
        BC-->>User: SSH session active
    end

    Note over User,DevEnv: User now has SSH access to DevEnv pod
