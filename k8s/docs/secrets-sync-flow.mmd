%%{init: {'theme': 'base', 'themeVariables': { 'primaryColor': '#FFD700'}}}%%
flowchart LR
    subgraph vault["Vault (vault namespace)"]
        KV["KV v2 Engine<br/>secret/devenv/credentials"]
        SSH["SSH Engine<br/>ssh/config/ca"]
        TFE["Terraform Engine<br/>terraform/creds/devenv"]
    end

    subgraph vso["VSO (vault-secrets-operator-system)"]
        Controller["VSO Controller"]
    end

    subgraph devenv["DevEnv (devenv namespace)"]
        subgraph crd["Custom Resources"]
            VaultConn["VaultConnection<br/>(default)"]
            VaultAuth["VaultAuth<br/>(kubernetes)"]
            StaticSecret["VaultStaticSecret<br/>(devenv-credentials)"]
            DynamicSecret["VaultDynamicSecret<br/>(tfe-token)"]
        end
        subgraph secrets["Kubernetes Secrets"]
            DevEnvSecrets["devenv-vault-secrets<br/>- GITHUB_TOKEN<br/>- LANGFUSE_*"]
            TFEToken["tfe-dynamic-token<br/>- TFE_TOKEN"]
            SSHCA["vault-ssh-ca<br/>- vault-ssh-ca.pub"]
            TLSCA["vault-tls-ca<br/>- vault-ca.crt"]
        end
        Pod["Agent Sandbox Pod<br/>(devenv-0)"]
    end

    %% VSO watches and syncs
    Controller -->|"1. Watch"| StaticSecret
    Controller -->|"2. Authenticate"| VaultAuth
    VaultAuth -->|"3. K8s Auth"| vault
    Controller -->|"4. Read secret/devenv/credentials"| KV
    Controller -->|"5. Create/Update"| DevEnvSecrets

    Controller -->|"Watch"| DynamicSecret
    Controller -->|"Lease Renewal"| TFE
    Controller -->|"Create/Update"| TFEToken

    %% Pod consumes secrets
    Pod -->|"envFrom"| DevEnvSecrets
    Pod -->|"envFrom"| TFEToken
    Pod -->|"volumeMount"| SSHCA
    Pod -->|"volumeMount"| TLSCA

    %% SSH CA is exported separately
    SSH -.->|"Manual export<br/>(configure-ssh-engine.sh)"| SSHCA

    %% Styles
    classDef vault fill:#FFD700,stroke:#FFA000,color:#000
    classDef vso fill:#FF9800,stroke:#E65100,color:#fff
    classDef crd fill:#E3F2FD,stroke:#1565C0,color:#000
    classDef secret fill:#E8F5E9,stroke:#4CAF50,color:#000
    classDef pod fill:#9C27B0,stroke:#6A1B9A,color:#fff

    class KV,SSH,TFE vault
    class Controller vso
    class VaultConn,VaultAuth,StaticSecret,DynamicSecret crd
    class DevEnvSecrets,TFEToken,SSHCA,TLSCA secret
    class Pod pod
